kubectl get deployments -o json | jq -r '.items[] | {namespace: .metadata.namespace, name: .metadata.name, containers: .spec.template.spec.containers[]} | [ .namespace, .name, (.containers | map(.resources.requests.cpu // "0") | map(sub("m";"") | tonumber) | add // 0) ] | @csv' | awk -F, 'NR==FNR{a[$1","$2]+=$3;next} {gsub("m","",$4);if($1","$2 in a) b[$1","$2]+=$4} END{for (i in a) print i, a[i]-(b[i]*1000)}' - <(kubectl top pods --all-namespaces --containers -o json | jq -r '.items[] | {namespace: .namespace, pod: .pod, containers: .containers[]} | .containers[] | [ .namespace, .pod, .name, .usage.cpu ] | @csv') | sort -t, -k3,3nr | head -n 10
